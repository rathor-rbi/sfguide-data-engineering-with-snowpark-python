name: Deploy Snowpark Apps

# Controls when the action will run. 
on:
  push:
    branches:
      - main

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Upgrade Snowflake CLI
        run: |
          pip install --upgrade snowflake-cli-labs
          which snow
          snow --version
          
      - name: Install Python packages
        run: pip install -r requirements.txt
      
      - name: Restore Snowflake Private Key
        env:
          SNOWFLAKE_PRIVATE_KEY: ${{ secrets.SNOWFLAKE_PRIVATE_KEY }}
        run: |
          mkdir -p ~/.snowflake
          echo "Debug: Checking private key secret..."
    
          # Check if the secret exists and has content
          if [ -z "$SNOWFLAKE_PRIVATE_KEY" ]; then
            echo "ERROR: SNOWFLAKE_PRIVATE_KEY secret is empty or not set"
            exit 1
          fi
    
          echo "Debug: Private key secret length: ${#SNOWFLAKE_PRIVATE_KEY}"
          echo "Debug: First 50 characters: ${SNOWFLAKE_PRIVATE_KEY:0:50}"
    
          # Process the private key
          echo "$SNOWFLAKE_PRIVATE_KEY" | tr -d '\r' | sed 's/\\n/\n/g' > ~/.snowflake/rsa_key.p8
          chmod 600 ~/.snowflake/rsa_key.p8
    
          # Verify the file was created and has content
          if [ ! -f ~/.snowflake/rsa_key.p8 ]; then
            echo "ERROR: Private key file was not created"
            exit 1
          fi
    
          echo "Debug: Private key file size: $(wc -c < ~/.snowflake/rsa_key.p8) bytes"
          echo "Debug: First line of key file:"
          head -1 ~/.snowflake/rsa_key.p8
          echo "Debug: Last line of key file:"
          tail -1 ~/.snowflake/rsa_key.p8
          echo "$SNOWFLAKE_PRIVATE_KEY" | tr -d '\r' | sed 's/\\n/\n/g' > ~/.snowflake/rsa_key.p8
          chmod 600 ~/.snowflake/rsa_key.p8
      
      - name: Configure SnowCLI
        env:
          SNOWFLAKE_ACCOUNT: ${{ secrets.SNOWFLAKE_ACCOUNT }}
          SNOWFLAKE_USER: ${{ secrets.SNOWFLAKE_USER }}
          SNOWFLAKE_ROLE: ${{ secrets.SNOWFLAKE_ROLE }}
          SNOWFLAKE_WAREHOUSE: ${{ secrets.SNOWFLAKE_WAREHOUSE }}
          SNOWFLAKE_DATABASE: ${{ secrets.SNOWFLAKE_DATABASE }}
        run: |
          cat > ~/.snowflake/config.toml <<EOL
          [connections.cicd]
          account = "${SNOWFLAKE_ACCOUNT}"
          user = "${SNOWFLAKE_USER}"
          authenticator = "SNOWFLAKE_JWT"
          private_key_path = "~/.snowflake/rsa_key.p8"
          role = "${SNOWFLAKE_ROLE}"
          warehouse = "${SNOWFLAKE_WAREHOUSE}"
          database = "${SNOWFLAKE_DATABASE}"
          EOL
          chmod 600 ~/.snowflake/config.toml
          chown $USER ~/.snowflake/config.toml
      
      - name: Deploy Snowpark apps
        env:
          SNOWFLAKE_ACCOUNT: ${{ secrets.SNOWFLAKE_ACCOUNT }}
          SNOWFLAKE_USER: ${{ secrets.SNOWFLAKE_USER }}
          SNOWFLAKE_PRIVATE_KEY: ${{ secrets.SNOWFLAKE_PRIVATE_KEY }}
          SNOWFLAKE_AUTHENTICATOR: ${{ secrets.SNOWFLAKE_AUTHENTICATOR }}
          SNOWFLAKE_ROLE: ${{ secrets.SNOWFLAKE_ROLE }}
          SNOWFLAKE_WAREHOUSE: ${{ secrets.SNOWFLAKE_WAREHOUSE }}
          SNOWFLAKE_DATABASE: ${{ secrets.SNOWFLAKE_DATABASE }}
        run: python deploy_snowpark_apps.py $GITHUB_WORKSPACE
